import streamlit as st
import pandas as pd

st.set_page_config(page_title="ãƒ—ãƒ­ç«¶é¦¬åˆ†æã‚·ã‚¹ãƒ†ãƒ ãƒ»æœ€çµ‚å®Œæˆç‰ˆ", layout="wide")

# --- é ‚ã„ãŸå…¨ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã•ã›ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ---
data_db = {
    "ï¼¡": {"â‘¢":{"win":"7/17","u5":"11/17","f_abc":["15/23","12/23","11/23"],"pop":[15,16,5,11,5,5,3,5,0,1],"idx":["8/20","13","3","4"],"idx_w":"10(3)"},"â‘£":{"win":"6/20","u5":"12/20","f_abc":["9/21","9/21","7/21"],"pop":[10,12,8,5,4,6,5,2,4,3],"idx":["9/20","7","10","6"],"idx_w":"12(3)"},"â‘¤":{"win":"3/9","u5":"8/9","f_abc":["4/12","4/12","6/12"],"pop":[6,10,5,4,3,1,2,2,2,0],"idx":["3/9","3","3","2"],"idx_w":"3"}},
    "ï¼¢": {"â‘¢":{"win":"3/6","u5":"5/6","f_abc":["4/8","4/8","3/8"],"pop":[6,2,4,2,3,1,3,1,0,0],"idx":["6/8","5","1","2"],"idx_w":"6(1)"},"â‘£":{"win":"10/19","u5":"9/19","f_abc":["8/20","12/20","4/20"],"pop":[11,12,7,4,1,5,6,1,3,1],"idx":["9/16","8","3","4"],"idx_w":"8(2)"},"â‘¤":{"win":"4/13","u5":"7/13","f_abc":["9/15","10/15","7/15"],"pop":[10,11,3,6,5,3,0,4,1,0],"idx":["6/12","2","4","3"],"idx_w":"5(1)"}},
    "ï¼£": {"â‘¢":{"win":"6/9","u5":"6/9","f_abc":["8/10","5/10","6/10"],"pop":[9,6,5,3,1,1,1,1,1,1],"idx":["2/5","2","2","3"],"idx_w":"3(1)"},"â‘£":{"win":"3/7","u5":"4/7","f_abc":["5/11","5/11","3/11"],"pop":[6,4,2,8,3,1,2,2,2,0],"idx":["2/10","4","4","5"],"idx_w":"4(2)"},"â‘¤":{"win":"4/6","u5":"4/6","f_abc":["4/8","3/8","5/8"],"pop":[3,2,5,1,5,1,2,1,1,1],"idx":["3/7","3","1","1"],"idx_w":"2"}},
    "ï¼¡ï¼¢": {"â‘¢":{"win":"9/13","u5":"12/13","f_abc":["14/17","11/17","7/17"],"pop":[13,13,7,5,3,4,0,1,1,2],"idx":["13/14","6","2","2"],"idx_w":"8(3)"},"â‘£":{"win":"3/5","u5":"6/11","f_abc":["5/12","7/12","6/12"],"pop":[7,8,3,4,5,4,2,1,0,1],"idx":["5/12","4","5","3"],"idx_w":"5(1)"},"â‘¤":{"win":"1/3","u5":"4/4","f_abc":["3/4","3/4","0/4"],"pop":[3,1,4,1,2,0,0,0,0,0],"idx":["2/4","3","0","0"],"idx_w":"2(1)"}},
    "ãƒãƒ¼ãƒãƒ¼ã‚¯": {"â‘¢":{"win":"10/27","u5":"12/27","f_abc":["5/7","4/7","3/7"],"pop":[6,6,4,2,1,2,2,0,3,1],"idx":["4/8","2","2","1"],"idx_w":"3"},"â‘£":{"win":"11/19","u5":"10/19","f_abc":["8/16","9/16","1/16"],"pop":[11,10,4,4,4,4,8,3,1,2],"idx":["2/8","3","2","4"],"idx_w":"4"},"â‘¤":{"win":"9/18","u5":"8/18","f_abc":["7/11","2/11","3/11"],"pop":[9,8,7,7,6,3,4,3,1,3],"idx":["2/10","3","4","3"],"idx_w":"3"}}
}

st.title("ğŸ‡ ç‹¬è‡ªãƒ­ã‚¸ãƒƒã‚¯ãƒ»çš„ä¸­å®Ÿç¸¾ å…¨è‡ªå‹•ç…§åˆã‚·ã‚¹ãƒ†ãƒ ")

# 1. ãƒ¬ãƒ¼ã‚¹å
race_name = st.text_input("ğŸ“ ãƒ¬ãƒ¼ã‚¹å", "ä¸­å±±â—¯ãƒ¬ãƒ¼ã‚¹")

# 2. æ¡ä»¶é¸æŠ
c1, c2 = st.columns(2)
target = c1.selectbox("ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ", ["ï¼¡", "ï¼¢", "ï¼£", "ï¼¡ï¼¢", "ï¼¡ï¼£", "ï¼¢ï¼£", "ï¼¡ï¼¢ï¼£", "ãƒãƒ¼ãƒãƒ¼ã‚¯"])
lv = c2.radio("ãƒ¬ãƒ™ãƒ«é¸æŠ", ["â‘¢", "â‘£", "â‘¤"], horizontal=True)
d = data_db.get(target, data_db["ï¼¡"]).get(lv, data_db["ï¼¡"]["â‘¢"])

st.divider()

# 3. é¦¬ç•ªå·å…¥åŠ›ï¼ˆã“ã“ã«å…¥åŠ›ã—ãŸç•ªå·ãŒä¸‹ã®äººæ°—è¡¨ã¨è‡ªå‹•ã§ç…§åˆã•ã‚Œã¾ã™ï¼‰
st.subheader("ğŸ´ å„é¦¬ã®é¦¬ç•ªã‚’å…¥åŠ›ï¼ˆåˆ†æç”¨ï¼‰")
col_abc = st.columns(3)
a_m = col_abc[0].text_input("ï¼¡é¦¬(ç•ª)", placeholder="5")
b_m = col_abc[1].text_input("ï¼¢é¦¬(ç•ª)", placeholder="6")
c_m = col_abc[2].text_input("ï¼£é¦¬(ç•ª)", placeholder="1")

col_idx = st.columns(4)
idx_m = [col_idx[i].text_input(f"ç‹¬è‡ªæŒ‡æ•°{i+1}ä½(ç•ª)", placeholder=f"{i}") for i in range(4)]

col_st = st.columns(3)
p_m = col_st[0].text_input("ï¼°é¦¬(ç•ª)", placeholder="8, 5")
t_m = col_st[1].text_input("ï¼´é¦¬(ç•ª)")
pt_m = col_st[2].text_input("ï¼°ï¼´é¦¬(ç•ª)")

st.divider()

# 4. äººæ°—å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã“ã“ã§ã€Œé †ã€ã«åŸ‹ã‚ã‚‹ï¼‰
st.subheader("ğŸ“Š äººæ°—é †ã«é¦¬ç•ªã‚’å…¥åŠ›ï¼ˆçš„ä¸­å®Ÿç¸¾ãŒè‡ªå‹•è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰")
pop_inputs = {}
cols = st.columns(2)
for i in range(1, 11):
    t_col = cols[0] if i <= 5 else cols[1]
    hits = d["pop"][i-1] if i-1 < len(d["pop"]) else 0
    pop_inputs[str(i)] = t_col.text_input(f"{i}ç•ªäººæ°—ï¼ˆçš„ä¸­å®Ÿç¸¾:{hits}å›ï¼‰ã®é¦¬ç•ª", key=f"p{i}")

st.divider()

# 5. ã€æœ¬å½“ã®äºˆæƒ³çµæœã€‘å…¥åŠ›ã•ã‚ŒãŸé¦¬ç•ªãŒã€Œä½•ç•ªäººæ°—ã€ã§ã€Œå®Ÿç¸¾ä½•å›ã‹ã€ã‚’å³åº§ã«åˆ¤å®š
st.header("ğŸ¯ ä»Šå›ã®ãƒ¬ãƒ¼ã‚¹ äºˆæƒ³åˆ¤å®šçµæœ")
# é¦¬ç•ªã‹ã‚‰äººæ°—ãƒ©ãƒ³ã‚¯ã‚’é€†å¼•ãã™ã‚‹è¾æ›¸ã‚’ä½œæˆ
num_to_rank = {v: k for k, v in pop_inputs.items() if v}

def show_result(name, num, past_hits):
    if num in num_to_rank:
        rank = num_to_rank[num]
        hits = d["pop"][int(rank)-1]
        st.success(f"**ã€{name}ã€‘é¦¬ç•ª{num}** ã¯ç¾åœ¨ **{rank}ç•ªäººæ°—** ã§ã™ã€‚ã“ã®æ¡ä»¶ã®éå»çš„ä¸­å®Ÿç¸¾ã¯ **{hits}å›** ã§ã™ï¼")
    elif num:
        st.warning(f"**ã€{name}ã€‘é¦¬ç•ª{num}** ã®äººæ°—ãŒæœªå…¥åŠ›ï¼ˆã¾ãŸã¯10ç•ªäººæ°—ä»¥ä¸‹ï¼‰ã§ã™ã€‚")

show_result("ï¼¡é¦¬", a_m, d["f_abc"][0])
show_result("ï¼¢é¦¬", b_m, d["f_abc"][1])
show_result("ï¼£é¦¬", c_m, d["f_abc"][2])

# ç‹¬è‡ªæŒ‡æ•°ã®åˆ¤å®š
for i, m_num in enumerate(idx_m):
    if m_num and m_num in num_to_rank:
        st.info(f"ç‹¬è‡ªæŒ‡æ•°{i+1}ä½ã®é¦¬ç•ª{m_num} ã¯ç¾åœ¨{num_to_rank[m_num]}ç•ªäººæ°—ï¼ˆçš„ä¸­å®Ÿç¸¾:{d['pop'][int(num_to_rank[m_num])-1]}å›ï¼‰")

st.divider()

# 6. åŸºæœ¬çš„ä¸­ç‡ã‚µãƒãƒªãƒ¼ï¼ˆï¼…è¡¨ç¤ºï¼‰
st.subheader("ğŸ“ˆ ã“ã®æ¡ä»¶ã®çš„ä¸­æœŸå¾…å€¤ï¼ˆï¼…ï¼‰")
def pct(frac):
    try:
        f = frac.split('(')[0]
        if '/' not in f: return "---"
        n, den = map(int, f.split('/'))
        return f"{(n/den)*100:.1f}%"
    except: return "---"

res_c = st.columns(4)
res_c[0].metric("è»¸1ç€ç¢ºç‡", pct(d["win"]), d["win"])
res_c[1].metric("é¦¬é€£5å†…", pct(d["u5"]), d["u5"])
res_c[2].metric("è¤‡å‹(A)", pct(d["f_abc"][0]), d["f_abc"][0])
res_c[3].metric("ABCãƒ¯ã‚¤ãƒ‰", pct(d["abc_w"]), d["abc_w"])
